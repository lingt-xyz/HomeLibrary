{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-4">
            <div class="card shadow-sm mb-4 border-0 bg-light">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small fw-bold mb-3">Your Progress</h6>
                    
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-trophy-fill me-2 {{ stats.color }} fs-4"></i>
                        <div>
                            <div class="fw-bold {{ stats.color }}">{{ stats.rank }}</div>
                            <div class="small text-muted">{{ stats.count }} Books Read</div>
                        </div>
                    </div>

                    <div class="progress mt-3" style="height: 12px; background-color: #e9ecef;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated 
                                    {# Conditionally add the glow class #}
                                    {{ 'glow-effect' if stats.progress >= 100 else 'bg-success' }}" 
                            role="progressbar" 
                            style="width: {{ stats.progress }}%;">
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-1">
                        <small class="text-muted">{{ stats.count }}</small>
                        <small class="text-muted">Next Rank: {{ stats.next }}</small>
                    </div>

                    {% if stats.progress >= 80 %}
                        <div class="alert alert-warning py-1 px-2 mt-3 small mb-0">
                            <i class="bi bi-lightning-fill"></i> Almost there! Just a few more.
                        </div>
                    {% endif %}
                </div>
            </div>
            <div class="card-header bg-white py-3 px-4 border-bottom d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <i class="bi bi-calendar3 me-3 text-primary fs-5"></i>
                    <h6 class="mb-0 fw-bold text-dark">Reading Activity</h6>
                </div>
                {# Dynamic label #}
                <small class="text-muted fw-semibold">Last {{ days_history|length }} Days</small>
            </div>
            <div class="card-body p-3">
                <div class="d-flex flex-wrap gap-2 justify-content-start">
                    {% for day in days_history %}
                        <div class="text-center" style="width: 45px;">
                            <div class="mb-1" style="font-size: 0.65rem; color: #6c757d; text-transform: uppercase;">
                                {{ day.date.strftime('%a') }}
                            </div>
                            
                            {# Color change: Success for Read, Light for Missed #}
                            <div class="rounded-circle d-flex align-items-center justify-content-center mx-auto shadow-sm
                                        {{ 'bg-success text-white' if day.is_read else 'bg-light text-muted border' }}
                                        {{ 'border-primary border-2' if day.is_today }}" 
                                style="width: 32px; height: 32px; font-size: 0.75rem;"
                                title="{{ day.date.strftime('%B %d, %Y') }}">
                                {% if day.is_read %}
                                    <i class="bi bi-check-lg"></i>
                                {% else %}
                                    {{ day.date.strftime('%d') }}
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <div class="mt-3 p-2 bg-light rounded d-flex justify-content-around align-items-center">
                    <div class="text-center">
                        <div class="small text-muted">Days Read</div>
                        <div class="fw-bold text-success">{{ days_history|selectattr('is_read')|list|length }}</div>
                    </div>
                    <div class="vr"></div>
                    <div class="text-center">
                        <div class="small text-muted">Missed</div>
                        <div class="fw-bold text-danger">{{ days_history|rejectattr('is_read')|list|length }}</div>
                    </div>
                </div>
            </div>
            
            

            <div class="card shadow-sm mb-4 border-0">
                <div class="card-header bg-success text-white py-2 fw-bold">Add New Book</div>
                <div class="card-body p-3">
                    <form action="{{ url_for('reader_dashboard') }}" method="POST">
                        <div class="mb-2">
                            <input type="text" name="title" class="form-control form-control-sm" placeholder="Book Title" required maxlength="200">
                        </div>
                        <div class="mb-2">
                            <input type="text" name="author" class="form-control form-control-sm" placeholder="Author" required>
                        </div>
                        <button type="submit" class="btn btn-sm btn-success w-100">Add to Library</button>
                    </form>
                </div>
            </div>

            <div class="card shadow-sm border-0">
                <div class="card-header bg-dark text-white py-2 fw-bold">My Reading History</div>
                <div class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;">
                    {% for record in history %}
                    <div class="list-group-item bg-white">
                        <div class="d-flex justify-content-between">
                            <h6 class="mb-1 fw-bold text-primary small">{{ record.book.title }}</h6>
                            <small class="text-muted" style="font-size: 0.7rem;">
                                {{ record.timestamp.strftime('%m/%d/%y') }}
                            </small>
                        </div>
                        <p class="mb-0 x-small text-muted fst-italic">"{{ record.comment }}"</p>
                    </div>
                    {% else %}
                    <div class="list-group-item text-center text-muted py-3 small">No history yet.</div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="col-md-8">
            
            <div class="mb-4">
                <div class="d-flex justify-content-between align-items-end mb-2">
                    <h3 class="mb-0">Library Catalog</h3>
                    {% if search_query %}
                        <span class="badge bg-info text-dark">
                            {{ total_results }} result{{ 's' if total_results != 1 }} for "{{ search_query }}"
                        </span>
                    {% endif %}
                </div>

                <form action="{{ url_for('reader_dashboard') }}" method="GET" class="d-flex gap-2">
                    <div class="input-group shadow-sm">
                        <span class="input-group-text bg-white"><i class="bi bi-search text-muted"></i></span>
                        <input type="text" name="q" class="form-control" 
                            placeholder="Search title or author..." value="{{ search_query or '' }}">
                        {% if search_query %}
                            <a href="{{ url_for('reader_dashboard') }}" class="btn btn-outline-secondary">Clear</a>
                        {% endif %}
                        <button type="submit" class="btn btn-primary px-4">Search</button>
                    </div>
                </form>
            </div>

            <div class="card shadow-sm border-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 30%;">Book Details</th>
                                <th style="width: 70%;">Your 100-Char Review</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for book in pagination.items %}
                            <tr>
                                <td>
                                    <div class="fw-bold text-truncate" style="max-width: 180px;">{{ book.title }}</div>
                                    <div class="text-muted small">{{ book.author }}</div>
                                </td>
                                <td>
                                    <form action="{{ url_for('add_comment', book_id=book.id) }}" method="POST" class="mb-3">
                                        <div class="input-group shadow-sm">
                                            <textarea name="comment"
                                                    id="comment-box-{{ book.id }}"
                                                    class="form-control form-control-sm border-end-0" 
                                                    rows="2" 
                                                    placeholder="What did you think?"
                                                    oninput="updateWordCount('{{ book.id }}')"
                                                    required
                                                    style="resize: none;">{{ user_comments.get(book.id, '') }}</textarea>
                                            
                                            <button type="submit" id="submit-btn-{{ book.id }}" 
                                                    class="btn {{ 'btn-info' if book.id in user_comments else 'btn-primary' }} d-flex align-items-center px-3"
                                                    disabled>
                                                <span>
                                                    <i class="bi {{ 'bi-pencil-square' if book.id in user_comments else 'bi-book' }} d-block"></i>
                                                    <small style="font-size: 0.65rem; text-transform: uppercase; font-weight: bold;">
                                                        {{ 'Update' if book.id in user_comments else 'Read' }}
                                                    </small>
                                                </span>
                                            </button>
                                        </div>

                                        <div class="d-flex justify-content-between px-2 mt-1">
                                            <small id="word-count-text-{{ book.id }}" class="text-muted" style="font-size: 0.75rem;">0 / 30 words</small>
                                            <div id="word-warning-{{ book.id }}" class="text-danger d-none" style="font-size: 0.75rem;">
                                                <i class="bi bi-info-circle me-1"></i>Min. 30 words
                                            </div>
                                        </div>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <nav class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if pagination.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('reader_dashboard', page=pagination.prev_num, q=search_query) }}">Previous</a>
                    </li>
                    {% endif %}
                    <li class="page-item disabled">
                        <span class="page-link text-dark">Page {{ pagination.page }} of {{ pagination.pages }}</span>
                    </li>
                    {% if pagination.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('reader_dashboard', page=pagination.next_num, q=search_query) }}">Next</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
</div>
<script src="{{ url_for('static', filename='js/validation.js') }}"></script>
{% endblock %}